<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZED CMS Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
  .hidden { display:none; }
  input, button, select, textarea { padding: 8px; margin:5px 0; width:100%; max-width:400px; }
  .card { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:5px; background:#fff; }
  img { max-width:150px; display:block; margin-top:5px; }
  audio { margin-top:5px; width:100%; }
  .totals { font-weight:bold; margin:10px 0; }
</style>
</head>
<body>

<h1>ZED CMS Dashboard</h1>

<!-- LOGIN FORM -->
<div id="loginDiv">
  <h2>Admin Login</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboardDiv" class="hidden">

  <h2>Totals</h2>
  <div class="totals" id="totals"></div>

  <h2>Create New Post</h2>
  <form id="postForm">
    <input type="text" name="title" placeholder="Title" required>
    <input type="text" name="artist" placeholder="Artist" required>
    <input type="text" name="slug" placeholder="Slug (unique)" required>
    <input type="text" name="category" placeholder="Category">
    <input type="text" name="tags" placeholder="Tags (comma separated)">
    <textarea name="description" placeholder="Description"></textarea>
    <input type="file" name="audio" accept="audio/*" required>
    <input type="file" name="image" accept="image/*" required>
    <button type="submit">Upload Post</button>
  </form>
  <p id="uploadMessage" style="color:green;"></p>

  <h2>Posts</h2>
  <div id="postsList"></div>

  <button onclick="logout()">Logout</button>
</div>

<script>
const API_URL = "https://cms.zedtopvibes.workers.dev";

// ===== LOGIN =====
async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const errorEl = document.getElementById("loginError");
  errorEl.textContent = "";

  try {
    const res = await fetch(API_URL + "/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if (data.success) {
      localStorage.setItem("zed_cms_token", data.token);
      showDashboard();
    } else {
      errorEl.textContent = data.message || "Login failed";
    }
  } catch(err) {
    errorEl.textContent = err.message;
  }
}

// ===== LOGOUT =====
function logout() {
  localStorage.removeItem("zed_cms_token");
  document.getElementById("dashboardDiv").classList.add("hidden");
  document.getElementById("loginDiv").classList.remove("hidden");
}

// ===== SHOW DASHBOARD =====
async function showDashboard() {
  document.getElementById("loginDiv").classList.add("hidden");
  document.getElementById("dashboardDiv").classList.remove("hidden");

  await loadTotals();
  await loadPosts();
}

// ===== LOAD TOTALS =====
async function loadTotals() {
  try {
    const res = await fetch(API_URL + "/totals");
    const data = await res.json();
    if (data.success) {
      document.getElementById("totals").textContent =
        `Posts: ${data.totalPosts}, Images: ${data.totalImages}, Audios: ${data.totalAudios}, Downloads: ${data.totalDownloads}`;
    }
  } catch(e) {
    document.getElementById("totals").textContent = "Failed to load totals";
  }
}

// ===== LOAD POSTS =====
async function loadPosts() {
  try {
    const list = await fetch(API_URL + "/posts").then(r => r.json()).catch(() => []);
    const postsDiv = document.getElementById("postsList");
    postsDiv.innerHTML = "";

    if (!Array.isArray(list) || list.length === 0) {
      postsDiv.textContent = "No posts yet.";
      return;
    }

    list.forEach(post => {
      const div = document.createElement("div");
      div.className = "card";

      div.innerHTML = `
        <strong>${post.title || "Untitled"}</strong><br>
        ${post.artist ? "Artist: " + post.artist + "<br>" : ""}
        ${post.category ? "Category: " + post.category + "<br>" : ""}
        ${post.tags?.length ? "Tags: " + post.tags.join(", ") + "<br>" : ""}
        ${post.description || ""}<br>
        ${post.image ? `<img src="${post.image}" alt="${post.title}">` : ""}
        ${post.audio ? `<audio controls src="${post.audio}"></audio>` : ""}
      `;
      postsDiv.appendChild(div);
    });
  } catch(e) {
    console.error(e);
  }
}

// ===== HANDLE NEW POST =====
document.getElementById("postForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const token = localStorage.getItem("zed_cms_token");
  const msgEl = document.getElementById("uploadMessage");
  msgEl.textContent = "";

  const formData = new FormData(form);

  try {
    const res = await fetch(API_URL + "/posts", {
      method: "POST",
      headers: { "Authorization": token },
      body: formData
    });
    const data = await res.json();
    if (data.success) {
      msgEl.style.color = "green";
      msgEl.textContent = "Post uploaded successfully!";
      form.reset();
      loadPosts();
      loadTotals();
    } else {
      msgEl.style.color = "red";
      msgEl.textContent = data.message || "Upload failed";
    }
  } catch(err) {
    msgEl.style.color = "red";
    msgEl.textContent = err.message;
  }
});

// ===== AUTO LOAD DASHBOARD IF LOGGED IN =====
if (localStorage.getItem("zed_cms_token")) {
  showDashboard();
}
</script>
</body>
</html>